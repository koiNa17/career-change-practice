import streamlit as st
import pandas as pd

# ãƒšãƒ¼ã‚¸è¨­å®š
st.set_page_config(page_title="Stock Analysis App", layout="wide")

# ã‚¿ã‚¤ãƒˆãƒ«
st.title("æ ªä¾¡åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ ğŸ“Š")

# --- 1. ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ ---
# æ¯å›èª­ã¿è¾¼ã‚€ã®ã¯ç„¡é§„ãªã®ã§ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆãƒ¡ãƒ¢ãƒªä¿å­˜ï¼‰æ©Ÿèƒ½ã‚’ä½¿ã†ã®ãŒãƒ—ãƒ­ã®ä½œæ³•ã§ã™ãŒã€
# ã¾ãšã¯ã‚·ãƒ³ãƒ—ãƒ«ã«èª­ã¿è¾¼ã¿ã¾ã™ã€‚
df = pd.read_csv("day13_analyzed_data.csv")

# --- 2. ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆæ“ä½œãƒ‘ãƒãƒ«ï¼‰ã®ä½œæˆ ---
st.sidebar.header("æ“ä½œãƒ‘ãƒãƒ« âš™ï¸")

# ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼šè¡¨ç¤ºã™ã‚‹æ—¥æ•°ã‚’å¤‰ãˆã‚‹
days_to_show = st.sidebar.slider(
    label="è¡¨ç¤ºã™ã‚‹æ—¥æ•° (éå»ã€œç¾åœ¨)",
    min_value=5,
    max_value=365,
    value=20  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
)

# ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼šRSIãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
show_high_rsi = st.sidebar.checkbox("RSI 70ä»¥ä¸Šï¼ˆè²·ã‚ã‚Œã™ãï¼‰ã®ã¿è¡¨ç¤º")

# --- 3. ãƒ‡ãƒ¼ã‚¿ã®åŠ å·¥ï¼ˆPandasã®åŠ›ï¼‰ ---
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œã«åˆã‚ã›ã¦ãƒ‡ãƒ¼ã‚¿ã‚’çµã‚Šè¾¼ã‚€

# ã¾ãšã€æŒ‡å®šã•ã‚ŒãŸæ—¥æ•°åˆ†ã ã‘åˆ‡ã‚Šå‡ºã™
df_display = df.tail(days_to_show)

# ã‚‚ã—ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒONãªã‚‰ã€RSIã§ã•ã‚‰ã«çµã‚Šè¾¼ã‚€
if show_high_rsi:
    # 'RSI'ã‚«ãƒ©ãƒ ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ã‹ã‚‰ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    if 'RSI' in df_display.columns:
        df_display = df_display[df_display['RSI'] >= 70]
    else:
        st.warning("ãƒ‡ãƒ¼ã‚¿ã«RSIåˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")

# --- 4. ãƒ¡ã‚¤ãƒ³ç”»é¢ã¸ã®è¡¨ç¤º ---

# A. ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªãƒãƒ£ãƒ¼ãƒˆï¼ˆStreamlitãƒã‚¤ãƒ†ã‚£ãƒ–ï¼‰
st.subheader(f"ç›´è¿‘ {days_to_show} æ—¥é–“ã®çµ‚å€¤æ¨ç§»")
# ãƒã‚¦ã‚¹ã‚ªãƒ¼ãƒãƒ¼ã§æ•°å€¤ãŒå‡ºã‚‹ãƒãƒ£ãƒ¼ãƒˆãŒ1è¡Œã§æ›¸ã‘ã¾ã™
st.line_chart(df_display[['Close', 'RSI']])

# B. ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«
st.subheader("ãƒ‡ãƒ¼ã‚¿è©³ç´°")
st.write(f"è¡¨ç¤ºä»¶æ•°: {len(df_display)} è¡Œ")
st.dataframe(df_display)

# C. å…ƒã®Matplotlibç”»åƒï¼ˆæ¯”è¼ƒç”¨ï¼‰
with st.expander("è©³ç´°ãªãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æç”»åƒã‚’è¦‹ã‚‹ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰"):
    st.image("my_stock_analysis.png", use_container_width=True)